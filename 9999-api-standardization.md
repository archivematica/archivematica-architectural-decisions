# Archivematica API standardization

* Status: proposed
* Deciders: Cole Maclean, Jesús García Crespo, Joel Simpson
* Date: 2019-04-22

## Context and problem statement

The current Archivematica REST API is inconsistent, incomplete, and lacking in
documentation. It is built using Tastypie, which has been suffering from lack
of maintenance resources lately.

## Considered options

* Django REST Framework
* Remple: REST Simple
* gRPC

## Decision outcome

TBD

### Positive consequences

A choice of any of the options should result in:

* Standardization (clear, consistent standard, such as REST described via
  OpenAPI)
* Documentation (autogenerated, with HTML forms for testing)
* Ease of consumption (via helper libs, especially in JavaScript and Python)

### Negative consequences

* Incompatibility with existing APIs (can be mitigated via a v2/ or v3/ in
  URL)

## Pros and cons of the options

### Django REST Framework

Thinking on the long term, Django REST framework is probably a safe choice for
a new Archivematica API given the broad interest in the Django community.
Encode OSS (maintainers of DRF) seem to have found financial support to some
extent. One concern though is to see some major interest from Encode towards
new frameworks and tooling that diverge from DRF, e.g. see all the work around
Starlette, APIstar, ASGI, etc… Is all this work going to eventually retrofeed
DRF or make it redundant?

A pratical concern here is that Django REST Framework no longer supports Django
1.8. While DRF 3.9 does have OpenAPI schema support built it, we would be stuck
on 3.6 until we’re able to upgrade Django to 1.11 or later.

### Remple: REST Simple

Remple is an API toolkit developed internally by Artefactual - a mini REST
framework.

Its first use case was the Storage Service API v3 (pull request #370, which was
not been merged yet) - in order to replace Tastypie, which is mostly in
maintenance mode. The goal was to have a simpler API layer that developers can
wrap their head around, but still provide a lot of the expected functionality
like support for OpenAPI 3.0 (spec is dynamically generated from the
application schema), auto-generation of client code and validation support.

This work received positive feedback from the Hudson Molonglo team. On the
other hand, its developer is not working for Artefactual anymore and the rest
of the team may prefer to abandon the idea of supporting a custom-made
framework.

### gRPC (or Twirp)

In the early days of Archivematica, XML-RPC was used as the RPC framework to
communicate the Archivematica web interface (Dashboard) with MCPServer in
order to interact with the workflow engine, namely to list and approve workflow
tasks awaiting decision.

Eventually, we had Gearman job server, which we were already using for job
scheduling purposes, replace XML-RPC. Using a message broker as the transport
brought lower setup costs and easy service discovery. In other words, we
moved from request-response to publish-subscribe, but we were still doing
request-response on top - which is a common pattern, with followers and
detractors.

Before REST became popular, XML-RPC or SOAP were more common. RPC (Remote
Procedure Call) has the advantage of being conceptually simpler.
Syntactically, it’s like calling a function of another library in the
programming language of choice.  The entities of the domain are hidden behind
these procedures.

MCPServer still uses this rpc-over-gearman approach described above. More
recently, it has learned to create and approve transfers as well as exposing
unit status or processing configuration details as part of an effort of moving
workflow-specific functionality to MCPServer that can now be consumed by the
Dashboard remotely.

We’ve contemplated before the possibility of having MCPServer become both the
workflow engine and the API server, with the benefit of simpler deployments and
less overhead in general. And if this was the approach we were taking, whether
exposing a RPC API is a good idea for general consumption and if that’s too much
of a departure from Django.

gRPC (Google) has become the most popular RPC framework and it provides very
interesting functionality like the gRPC JSON gateway optionally emitting
OpenAPI definitions, gRPC Web, or powerful semantics like server streaming,
which we could use to build RPCs with streams of digital preservation events.
Alternatively, the engineering team from Twitch launched Twirp, a simpler RPC
framework that solves some of the annoyances in gRPC but with a smaller feature
set and community.

## Links

* [Django REST Framework](https://www.django-rest-framework.org/)
* [Remple branch](https://github.com/artefactual/archivematica-storage-service/tree/2c4f950780f06caf231d1e2a9a3b97ff9c887f61/storage_service/locations/api/beta/remple)
* [gRPC](https://grpc.io/)
* [Twirp](https://github.com/twitchtv/twirp)
